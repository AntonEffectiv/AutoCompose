!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):e.AutoCompose=n()}(this,function(){"use strict";var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e=function(e,n,t){return n&&o(e.prototype,n),t&&o(e,t),e};function o(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function r(e,n,t){if(n="autosuggest_"+n,void 0===t)return void 0!==(t=e.dataset[n])?JSON.parse(e.dataset[n]):t;e.dataset[n]=JSON.stringify(t)}function b(e,n){var t=void 0;if(e.nextSibling)t=e.nextSibling;else{for(t=e.parentNode;t!==n&&!t.nextSibling;)t=t.parentNode;if(!t||t===n)return;t=t.nextSibling}return A(t)}function S(e,n){var t=void 0;if(e.previousSibling)t=e.previousSibling;else{for(t=e.parentNode;t!==n&&!t.previousSibling;)t=t.parentNode;if(!t||t===n)return;t=t.previousSibling}return w(t)}function C(e){return e.tagName&&"BR"===e.tagName?"\n":e.nodeValue||""}function E(e){var n=window.getSelection(),t=document.createRange();e(t),n.removeAllRanges(),n.addRange(t)}var n=[].concat(["fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing","tabSize","MozTabSize"],["direction","boxSizing","width","borderRightWidth","borderLeftWidth","paddingRight","paddingLeft"]),A=([].concat(function(e){if(Array.isArray(e)){for(var n=0,t=Array(e.length);n<e.length;n++)t[n]=e[n];return t}return Array.from(e)}(n),["overflowX","overflowY","borderTopWidth","borderBottomWidth","borderStyle","paddingTop","paddingBottom","lineHeight"]),function(e){for(var n=e;n.firstChild;)n=n.firstChild;return n}),w=function(e){for(var n=e;n.lastChild;)n=n.lastChild;return n};function u(e){var o=this;if(function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,u),!e)throw Error("AutoCompose: Missing required parameter, options");"function"==typeof e&&(e={composer:e}),this.inputs=[],this.onChange=e.onChange||Function.prototype,this.onReject=e.onReject||Function.prototype,function(n,t,e){[].concat(e).forEach(function(e){if(void 0===t[e])throw Error("AutoCompose: Missing required parameter, "+n+"."+e)})}("AutoCompose",e,"composer"),function(t,e,o,r){[].concat(e[o]).forEach(function(e){var n=void 0===e?"undefined":a(e);if(n!==r&&"undefined"!==n)throw new TypeError("AutoCompose: Invalid Type for "+t+"."+o+", expected "+r)})}("AutoCompose",e,"composer","function"),this.composer=e.composer;function r(e){var n=h.parentNode;n.removeChild(h),e&&n.normalize(),h=m=null}function l(e){var n=h.firstChild.nodeValue;h.parentNode.insertBefore(h.firstChild,h);var t=h.previousSibling;r(),e||E(function(e){e.setStartAfter(t),e.setEndAfter(t)}),o.onChange({suggestion:m,acceptedSuggestion:n})}function c(){r(),o.onReject({suggestion:m})}function p(e){return e.parentNode===h}var y=this,v=!1,h=null,m=null;this.onBlurHandler=function(){return h&&r(!0)},this.onKeyDownHandler=function(e){h&&(9===e.keyCode||39===e.keyCode||40===e.keyCode?(l(),v=!0,e.preventDefault()):c())};var g=0;this.onKeyUpHandler=function(e){var n=this;if("keyup"===e.type&&v)v=!1;else{var t=function(){var e=window.getSelection();if(!e.isCollapsed)return{};var n=e.getRangeAt(0),t=n.startContainer,o=n.startOffset;if(t.nodeType!==t.TEXT_NODE)try{t=A(t.childNodes[o]),o=0}catch(e){try{o=(t=w(t.childNodes[o-1])).nodeValue?t.nodeValue.length:null}catch(e){}}return{node:t,offset:o}}(),r=t.node,i=t.offset;if(r){var o=p(r);if("mouseup"===e.type&&h){if(o&&i)return r.nodeValue=r.nodeValue.slice(0,i),l();if(function(e){for(;(e=S(e))&&p(e););return!!e}(r))return l(!0)}if(o)try{r=S(h),i=r.nodeValue.length}catch(e){r=b(h),i=0}if(r.nodeType===r.TEXT_NODE){h&&c();var a=r.nodeValue.slice(i);if(!a.trim()){for(var u=r;u=b(u,this);)if((a+=C(u)).trim())return;var f,s="";s=r.nodeValue.slice(0,i);for(var d=r;d=S(d,this);)s=C(d)+s;f=++g,y.composer.call(n,s,function(e){if(e&&f===g){var n=r.nodeValue.slice(i),t=r.parentNode,o=r.nextSibling;r.nodeValue=r.nodeValue.slice(0,i),t.insertBefore(document.createTextNode(n),o),(h=function(e){var n=document.createElement("div");return n.innerHTML=e.trim(),n.firstChild}("<span>"+(m=e)+"</span>")).style.opacity=.7,h.id="___autocompose_inline_suggestion___",t.insertBefore(h,o),E(function(e){e.setStartBefore(h),e.setEndBefore(h)})}})}}}}};for(var n=arguments.length,t=Array(1<n?n-1:0),i=1;i<n;i++)t[i-1]=arguments[i];this.addInputs.apply(this,t)}return e(u,[{key:"addInputs",value:function(){for(var n=this,e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];Array.prototype.concat.apply([],t.map(function(e){return e[0]?Array.prototype.slice.call(e,0):e})).forEach(function(e){if(!e.isContentEditable)throw Error("AutoCompose: Invalid input: only contenteditable elements are supported");e.addEventListener("blur",n.onBlurHandler),e.addEventListener("keyup",n.onKeyUpHandler),e.addEventListener("mouseup",n.onKeyUpHandler),e.addEventListener("keydown",n.onKeyDownHandler,!0),r(e,"index",n.inputs.push(e)-1)})}},{key:"removeInputs",value:function(){for(var t=this,e=arguments.length,n=Array(e),o=0;o<e;o++)n[o]=arguments[o];Array.prototype.concat.apply([],n.map(function(e){return e[0]?Array.prototype.slice.call(e,0):e})).forEach(function(e){var n=r(e,"index");isNaN(n)||(t.inputs.splice(n,1),e.removeEventListener("blur",t.onBlurHandler),e.removeEventListener("keyup",t.onKeyUpHandler),e.removeEventListener("mouseup",t.onKeyUpHandler),e.removeEventListener("keydown",t.onKeyDownHandler,!0))})}},{key:"destroy",value:function(){this.removeInputs(this.inputs)}}]),u});
